---
const GITHUB_ORG = "lokabisa-oss";

const headers = {
	Accept: "application/vnd.github.mercy-preview+json",
	"User-Agent": "lokabisa-oss-site",
	Authorization: `Bearer ${import.meta.env.GITHUB_TOKEN}`,
};


const orgRes = await fetch(`https://api.github.com/orgs/${GITHUB_ORG}`, {
  	headers,
});

const org = orgRes.ok
  ? await orgRes.json()
  : { avatar_url: "/logo.png" };

const reposRes = await fetch(
  `https://api.github.com/orgs/${GITHUB_ORG}/repos?per_page=100&sort=updated`,
  { headers }
);

let repos = reposRes.ok ? await reposRes.json() : [];

repos = repos
  .filter((r: { fork: any; archived: any; name: string; }) => !r.fork && !r.archived && r.name !== "oss.lokabisa.id")
  .map((r: { name: any; description: any; html_url: any; stargazers_count: any; topics: any; pushed_at: any; }) => ({
    name: r.name,
    desc: r.description || "No description provided.",
    url: r.html_url,
    stars: r.stargazers_count,
  	topics: r.topics || [],
	updatedAt: r.pushed_at,
  }));

function timeAgo(dateString: string | number | Date) {
  const diff = Date.now() - new Date(dateString).getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days < 1) return "today";
  if (days < 7) return `${days}d ago`;
  if (days < 30) return `${Math.floor(days / 7)}w ago`;
  return `${Math.floor(days / 30)}mo ago`;
}

---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lokabisa OSS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Open-source projects and public infrastructure by Lokabisa."
    />
    <link rel="stylesheet" href="/styles/base.css" />
  </head>

  <body>
    <main class="container">
		<header class="header">
			<div class="brand">
			  <img src={org.avatar_url} alt="Lokabisa OSS" />
			  <div class="brand-text">
				<h1>Lokabisa OSS</h1>
				<p>Open-source projects & public infrastructure.</p>
			  </div>
			</div>
		</header>

		<div class="divider"></div>

		<section class="projects">
			{repos.map((repo: {
[x: string]: any; name: unknown; url: string | URL | null | undefined; stars: unknown; desc: unknown; 
}) => {
				const isFeatured = repo.name === "region-id";
				return (
				  <div class={`card ${isFeatured ? "featured" : ""}`}>
					 <a class="card-link" href={repo.url} target="_blank"></a>
					<div class="card-head">
					  <h2>
						{repo.name}
						{isFeatured && <span class="badge">Featured</span>}
					  </h2>
					  <span class="meta">★ {repo.stars}</span>

					</div>
					<p>{repo.desc}</p>
					<div class="card-actions">
						<a
						href="https://github.com/lokabisa-oss/region-id/releases"
						target="_blank"
						rel="noopener"
						class="release-link"
						>
						Download datasets →
						</a>
					</div>
					<div class="card-meta">
						<span class="updated">Updated {timeAgo(repo.updatedAt)}</span>
					</div>
					{repo.topics?.length > 0 && (
						<div class="tags">
							{repo.topics.slice(0, 4).map((tag: unknown) => (
							<span class="tag">{tag}</span>
							))}
						</div>
						)}

				  </div>
				);
			  })}
			  
		</section>

		<footer class="footer">
			<p>
			Built by Lokabisa ·
			<a href="https://github.com/lokabisa-oss" target="_blank">
				GitHub
			</a>
			</p>
		</footer>
    </main>
  </body>
</html>
